<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - LemonCity Events</title>
    <link rel="icon" href="fotosito.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: url('sfondosito2.png') center center fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .login-container {
            background: rgba(10, 14, 39, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .logo { font-size: 4em; margin-bottom: 15px; filter: drop-shadow(0 0 10px rgba(33,150,243,0.5)); }
        h1 { color: #2196f3; font-size: 2em; margin-bottom: 5px; }
        .subtitle { color: #aaa; font-size: 0.9em; margin-bottom: 30px; }

        .discord-btn {
            background: #5865F2;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, background 0.2s;
        }

        .discord-btn:hover { transform: translateY(-2px); background: #4752C4; }
        
        .status-msg {
            margin-top: 20px;
            font-size: 0.9em;
            min-height: 20px;
            color: #ffd700;
        }

        .error-msg { color: #ff4444; margin-top: 15px; display: none; }
    </style>
</head>
<body>

    <div class="login-container">
        <div class="logo">üçã</div>
        <h1>LEMONCITY</h1>
        <p class="subtitle">Accedi per gestire i tuoi eventi</p>

        <button class="discord-btn" id="loginBtn" onclick="signInWithDiscord()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037 13.468 13.468 0 0 0-.59 1.227 18.25 18.25 0 0 0-4.657 0 13.468 13.468 0 0 0-.59-1.227.074.074 0 0 0-.079-.037A19.791 19.791 0 0 0 3.673 4.37a.073.073 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-1.28 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.118.098.246.198.373.292a.077.077 0 0 1-.006 1.279 12.29 12.29 0 0 1-1.873.892.076.076 0 0 0-.04.106 15.01 15.01 0 0 0 1.226 1.994.077.077 0 0 0 .084.028 19.9 19.9 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.074.074 0 0 0-.031-.028z"/></svg>
            Accedi con Discord
        </button>

        <div id="status" class="status-msg"></div>
        <div id="error" class="error-msg"></div>
    </div>

    <script>
        // CONFIGURAZIONE SUPABASE
        const supabaseUrl = 'https://vdgpfhfztbnqzobtgkrb.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkZ3BmaGZ6dGJucXpvYnRna3JiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NzU4NDYsImV4cCI6MjA3NzM1MTg0Nn0.Wr-zs_Og1K48R9Fls2ImoeNKV6YGqtmkb2X5cbC-ZN8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        async function signInWithDiscord() {
            const btn = document.getElementById('loginBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            status.textContent = "üîÑ Reindirizzamento a Discord...";

            // Usa window.location.href per dire a Supabase di tornare ESATTAMENTE QUI
            // Cos√¨ possiamo processare i dati prima di andare alla index
            const redirectUrl = window.location.href.split('#')[0].split('?')[0];

            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'discord',
                options: {
                    redirectTo: redirectUrl // Torniamo qui per salvare i dati
                }
            });

            if (error) {
                status.textContent = "";
                const errDiv = document.getElementById('error');
                errDiv.style.display = 'block';
                errDiv.textContent = "Errore: " + error.message;
                btn.disabled = false;
            }
        }

        // GESTIONE AL RITORNO DA DISCORD
        // Questo codice parte quando la pagina si ricarica dopo il login
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                document.getElementById('status').textContent = "‚úÖ Login riuscito! Accesso in corso...";
                document.getElementById('loginBtn').style.display = 'none';

                // 1. PRENDIAMO I DATI DA SUPABASE
                const discordData = session.user.user_metadata;
                
                // Cerchiamo l'ID corretto di Discord nelle identit√† collegate
                let discordId = null;
                if (session.user.identities && session.user.identities.length > 0) {
                    discordId = session.user.identities[0].id; 
                }

                // 2. CREIAMO L'OGGETTO CHE INDEX.HTML SI ASPETTA
                const lemonUser = {
                    username: discordData.full_name || discordData.name || session.user.email,
                    discordId: discordId || session.user.id, // Fallback se non trova ID Discord
                    avatar: discordData.avatar_url,
                    email: session.user.email
                };

                // 3. SALVIAMO NEL LOCALSTORAGE (Il "ponte" per index.html)
                localStorage.setItem('lemon_user', JSON.stringify(lemonUser));

                // 4. ORA POSSIAMO ANDARE ALLA INDEX
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        });

        // Controllo se c'√® un errore nell'URL (es. utente annulla login)
        const params = new URLSearchParams(window.location.hash.substring(1));
        if (params.get('error')) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = "Login annullato o fallito.";
        }
    </script>
</body>
</html>
